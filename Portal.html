<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GEA Member Portal</title>

  <!-- ============================================================ -->
  <!-- FAVICON                                                      -->
  <!-- Display GEA logo in browser tab                              -->
  <!-- ============================================================ -->
  <link rel="icon" type="image/png" href="https://storage.googleapis.com/gea-public-assets/gea-logo-round-32.png">

  <!-- ============================================================ -->
  <!-- FONTS: Source Sans 3 for UI, Roboto Mono for data display   -->
  <!-- ============================================================ -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* ============================================================ */
    /* RESET AND DEFAULTS                                           */
    /* ============================================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      font-family: 'Source Sans 3', 'Segoe UI', Arial, sans-serif;
      font-size: 14px;
      color: #333333;
      background: #F5F5F5;
    }
    
    /* ============================================================ */
    /* COLOR CONSTANTS (from Config.gs)                             */
    /* ============================================================ */
    :root {
      --color-primary: #0A3161;
      --color-accent: #B31942;
      --color-white: #FFFFFF;
      --color-secondary-blue: #ABCAE9;
      --color-black: #000000;
      --color-success: #2E7D32;
      --color-warning: #E65100;
      --color-danger: #C62828;
      --color-info: #1565C0;
      --color-light-gray: #F5F5F5;
      --color-medium-gray: #757575;
      --color-border-gray: #E0E0E0;
    }
    
    /* ============================================================ */
    /* APP LAYOUT                                                   */
    /* Flex column: header at top, centered content below           */
    /* ============================================================ */
    
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    #header {
      background: var(--color-primary);
      border-bottom: 4px solid var(--color-accent);
      color: var(--color-white);
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-radius: 4px;
      padding: 4px 8px;
      transition: background-color 0.2s ease;
    }

    .header-left:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .header-logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-logo img {
      max-width: 40px;
      max-height: 40px;
      object-fit: contain;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .header-user {
      font-size: 12px;
      text-align: right;
    }
    
    .header-user-name {
      font-weight: 600;
      font-size: 13px;
    }
    
    .header-user-role {
      font-size: 11px;
      opacity: 0.85;
    }
    
    /* ============================================================ */
    /* LOGIN SCREEN                                                 */
    /* Centered form shown when no token                            */
    /* ============================================================ */
    
    #loginScreen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary-blue) 100%);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    #loginScreen.show {
      display: flex;
    }
    
    .login-card {
      background: var(--color-white);
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-logo img {
      max-width: 80px;
      max-height: 80px;
      object-fit: contain;
    }
    
    .login-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 8px;
    }
    
    .login-subtitle {
      font-size: 13px;
      color: var(--color-medium-gray);
      margin-bottom: 24px;
    }
    
    .login-form {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }
    
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555555;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--color-border-gray);
      border-radius: 4px;
      font-family: 'Source Sans 3', sans-serif;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(10,49,97,0.15);
    }
    
    .login-error {
      display: none;
      background: #FFEBEE;
      border: 2px solid var(--color-danger);
      color: var(--color-danger);
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .login-error.show {
      display: block;
    }
    
    /* ============================================================ */
    /* BUTTONS                                                      */
    /* ============================================================ */
    
    button, .btn {
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Source Sans 3', sans-serif;
    }
    
    .btn-primary {
      background: var(--color-primary);
      color: var(--color-white);
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #0D3D7A;
    }
    
    .btn-primary:disabled {
      background: var(--color-secondary-blue);
      cursor: not-allowed;
    }
    
    .btn-danger {
      background: var(--color-danger);
      color: var(--color-white);
    }
    
    .btn-danger:hover:not(:disabled) {
      background: #B71C1C;
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--color-primary);
      color: var(--color-primary);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #EFF6FF;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .btn-logout {
      background: var(--color-accent);
      color: var(--color-white);
      padding: 8px 14px;
      font-size: 12px;
    }
    
    .btn-logout:hover {
      background: #A01436;
    }
    
    /* ============================================================ */
    /* MAIN CONTENT AREA                                            */
    /* Centered column layout with max-width                        */
    /* ============================================================ */
    
    #content {
      flex: 1;
      background: var(--color-light-gray);
      padding: 24px;
      overflow-y: auto;
      display: flex;
      justify-content: center;
    }
    
    .content-column {
      width: 85vw;
      max-width: 85vw;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* ============================================================ */
    /* PAGE ELEMENTS                                                */
    /* ============================================================ */
    
    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 24px;
    }
    
    .section-heading {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-primary);
      margin-bottom: 12px;
      margin-top: 20px;
    }
    
    .card {
      background: var(--color-white);
      border: 1px solid var(--color-border-gray);
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 20px 24px;
      margin-bottom: 20px;
    }
    
    .card-header {
      border-top: 4px solid var(--color-primary);
      margin: -20px -24px 16px -24px;
      padding: 16px 24px;
      background: #FAFAFA;
    }
    
    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-primary);
      margin: 0;
    }
    
    /* ============================================================ */
    /* STATUS BADGES                                                */
    /* ============================================================ */
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-pending {
      background: #FFF3E0;
      color: var(--color-warning);
      border: 1px solid #FFE0B2;
    }
    
    .badge-confirmed {
      background: #E3F2FD;
      color: #1565C0;
      border: 1px solid #BBDEFB;
    }
    
    .badge-approved {
      background: #E8F5E9;
      color: var(--color-success);
      border: 1px solid #C8E6C9;
    }
    
    .badge-cancelled {
      background: #FFEBEE;
      color: var(--color-danger);
      border: 1px solid #FFCDD2;
    }
    
    /* ============================================================ */
    /* INFO / WARNING / SUCCESS BOXES                               */
    /* ============================================================ */
    
    .info-box {
      background: #EFF6FF;
      border-left: 5px solid var(--color-primary);
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .warning-box {
      background: #FFF0F3;
      border: 2px solid var(--color-accent);
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--color-accent);
      font-weight: 600;
    }
    
    .success-box {
      background: #F1F8E9;
      border-left: 5px solid var(--color-success);
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    /* ============================================================ */
    /* DETAIL ROWS                                                  */
    /* Two-column layout for displaying data                        */
    /* ============================================================ */
    
    .detail-row {
      display: flex;
      padding: 6px 0;
      border-bottom: 1px solid var(--color-border-gray);
      line-height: 1.4;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 700;
      color: #666666;
      flex-shrink: 0;
      margin-right: 8px;
    }

    .detail-label::after {
      content: ":";
    }

    .detail-value {
      flex: 1;
      color: #333333;
      word-break: break-word;
    }
    
    /* ============================================================ */
    /* TABLES                                                       */
    /* ============================================================ */
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-white);
      border: 1px solid var(--color-border-gray);
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    thead {
      background: var(--color-primary);
      color: var(--color-white);
    }
    
    th {
      padding: 10px 14px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    td {
      padding: 10px 14px;
      border-bottom: 1px solid #F0F0F0;
    }
    
    tbody tr:hover {
      background: #EFF6FF;
    }
    
    /* ============================================================ */
    /* EMPTY STATE                                                  */
    /* ============================================================ */
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--color-medium-gray);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 14px;
      margin-bottom: 4px;
    }

    /* Back to Dashboard Navigation */
    .back-to-dashboard {
      display: inline-block;
      margin: 0 0 20px 0;
      padding: 8px 12px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      color: var(--color-primary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .back-to-dashboard:hover {
      background-color: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    /* ============================================================ */
    /* RESPONSIVE ADJUSTMENTS                                       */
    /* ============================================================ */
    
    @media (max-width: 768px) {
      #header {
        padding: 0 16px;
        height: 56px;
      }

      #content {
        padding: 16px;
      }

      .content-column {
        width: 100%;
        max-width: 100%;
      }

      .detail-row {
        flex-direction: column;
      }

      .detail-label {
        width: auto;
        margin-bottom: 4px;
      }
    }

    /* ============================================================ */
    /* DASHBOARD ENHANCEMENTS                                        */
    /* ============================================================ */

    /* Alert Banners */
    .alert-banner {
      margin: 0 0 20px 0;
      padding: 12px 16px;
      border-left: 4px solid #999;
      background-color: #f5f5f5;
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .alert-banner-danger {
      border-left-color: var(--color-danger);
      background-color: #fce4e4;
    }

    .alert-banner-warning {
      border-left-color: var(--color-warning);
      background-color: #fff3e0;
    }

    .alert-banner-info {
      border-left-color: var(--color-info);
      background-color: #e3f2fd;
    }

    .alert-banner-text {
      flex: 1;
      font-size: 14px;
      color: #333;
    }

    .alert-banner-close {
      cursor: pointer;
      color: #999;
      font-size: 18px;
      line-height: 1;
      background: none;
      border: none;
      padding: 0;
    }

    /* Quota Progress Bars */
    .quota-bar-container {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 8px 0;
    }

    .quota-bar-fill {
      height: 100%;
      background-color: var(--color-primary);
      transition: background-color 0.3s ease;
      border-radius: 10px;
    }

    .quota-bar-fill.warning {
      background-color: var(--color-warning);
    }

    .quota-bar-fill.danger {
      background-color: var(--color-danger);
    }

    .quota-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* Dues Grid */
    .dues-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .dues-row {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background-color: #fafafa;
    }

    .dues-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dues-value {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-top: 4px;
    }

    .dues-value.positive {
      color: var(--color-success);
    }

    .dues-value.negative {
      color: var(--color-danger);
    }

    /* Privilege Badges */
    .privilege-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .privilege-yes {
      background-color: #e8f5e9;
      color: var(--color-success);
    }

    .privilege-no {
      background-color: #eeeeee;
      color: #999;
    }

    /* Quick Actions Grid */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border: none;
      border-radius: 8px;
      background-color: var(--color-primary);
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .quick-action-btn:hover {
      background-color: #08254d;
    }

    .quick-action-icon {
      font-size: 24px;
      line-height: 1;
    }

    /* Dashboard 2-Column Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .dashboard-grid .card {
      margin: 0;
    }

    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

    /* Member Status Badge */
    .status-active {
      background-color: #e8f5e9;
      color: var(--color-success);
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
    }

    .status-inactive {
      background-color: #ffebee;
      color: var(--color-danger);
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
    }

    /* Document Status Icons */
    .doc-status {
      font-size: 14px;
      text-align: center;
    }

    /* Household Members Table */
    .household-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .household-table th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
    }

    .household-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .household-table tr:hover {
      background-color: #fafafa;
    }

    /* Reservations Table */
    .reservations-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .reservations-table th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
    }

    .reservations-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .reservations-table tr:hover {
      background-color: #fafafa;
    }

    .cancel-btn-small {
      background-color: transparent;
      color: var(--color-danger);
      border: 1px solid var(--color-danger);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }

    .cancel-btn-small:hover {
      background-color: var(--color-danger);
      color: white;
    }

    /* Card content with balanced layout */
    .card-content-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .card-content-split {
        grid-template-columns: 1fr;
      }

      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .dues-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- ============================================================ -->
<!-- APP STRUCTURE                                                -->
<!-- Main container for login and authenticated app               -->
<!-- ============================================================ -->

<div id="app">
  
<!-- ============================================================ -->
<!-- LOGIN SCREEN                                                 -->
<!-- Shown when no valid token is found.                          -->
<!-- Now requires both email and password for authentication.     -->
<!-- ============================================================ -->

<div id="loginScreen" class="show">
  <div class="login-card">
    <div class="login-logo">
      <img src="https://storage.googleapis.com/gea-public-assets/gea-logo-round-120.png" alt="GEA Logo">
    </div>
    <h1 class="login-title">GEA Member Portal</h1>
    <p class="login-subtitle">Sign in with your GEA account</p>
    <div class="login-error" id="loginError"></div>
    <form class="login-form" onsubmit="submitLogin(event)">
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" id="loginEmail" class="form-input" placeholder="you@state.gov" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="12">
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
    </form>
    <p style="font-size: 12px; color: #999; margin-top: 16px;">
      Passwords must be at least 12 characters.
    </p>
  </div>
</div> 


  <!-- ============================================================ -->
  <!-- MAIN APP (shown after authentication)                        -->
  <!-- ============================================================ -->
  
  <!-- ============================================================ -->
  <!-- HEADER / NAV BAR                                             -->
  <!-- Logo, title, and user menu                                  -->
  <!-- ============================================================ -->
  <header id="header" style="display: none;">
    <div class="header-left" onclick="showPage('dashboard'); return false;" title="Back to Dashboard">
      <div class="header-logo">
        <img src="https://storage.googleapis.com/gea-public-assets/gea-logo-round-80.png" alt="GEA Logo">
      </div>
      <div class="header-title">Member Portal</div>
    </div>
    <div class="header-right">
      <div class="header-user">
        <div class="header-user-name" id="headerUserName">‚Äî</div>
        <div class="header-user-role" id="headerHouseholdName">‚Äî</div>
      </div>
      <button class="btn-logout" onclick="logout();">Logout</button>
    </div>
  </header>
  
  <!-- ============================================================ -->
  <!-- CONTENT AREA                                                -->
  <!-- All page views contained within                             -->
  <!-- ============================================================ -->
  <div id="content" style="display: none;">
    <div class="content-column">
      
      <!-- ========================================================== -->
      <!-- PAGE: DASHBOARD                                            -->
      <!-- Member's home page with overview and quick links           -->
      <!-- ========================================================== -->
      <div id="dashboard" class="page active">
        <h1 class="page-title">Dashboard</h1>

        <!-- Quick Actions - Top of Page -->
        <div id="quickActionsContainer"></div>

        <!-- Alert Banners -->
        <div id="alertBanners"></div>

        <!-- Two-Column Grid: Membership & Household Members -->
        <div class="dashboard-grid">
          <!-- Membership Card -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Membership</h2>
            </div>
            <div id="membershipCard">
              <p style="text-align: center; color: #999; padding: 20px;">Loading...</p>
            </div>
          </div>

          <!-- Household Members -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Household Members</h2>
            </div>
            <div id="householdMembers">
              <p style="text-align: center; color: #999; padding: 20px;">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Two-Column Grid: Reservations & Quotas -->
        <div class="dashboard-grid">
          <!-- Upcoming Reservations -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Upcoming Reservations</h2>
            </div>
            <div id="upcomingReservations">
              <div class="empty-state">
                <div class="empty-state-icon">üìÖ</div>
                <div class="empty-state-text">No upcoming reservations</div>
              </div>
            </div>
          </div>

          <!-- Facility Usage Quotas -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Facility Usage Quotas</h2>
            </div>
            <div id="facilityQuotas">
              <p style="text-align: center; color: #999; padding: 20px;">Loading...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ========================================================== -->
      <!-- PAGE: RESERVATIONS                                         -->
      <!-- Book, view, and cancel facility reservations              -->
      <!-- ========================================================== -->
      <div id="reservations" class="page">
        <h1 class="page-title">Reservations</h1>
        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>

        <!-- Book New Reservation -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Book a New Reservation</h2>
          </div>
          <form onsubmit="submitReservation(event)">
            <div class="form-group">
              <label class="form-label">Facility</label>
              <select id="facility" class="form-input" required>
                <option value="">-- Select a facility --</option>
                <option value="Tennis Courts">Tennis Courts</option>
                <option value="Leobo Lodge">Leobo Lodge</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Event Date</label>
              <input type="date" id="eventDate" class="form-input" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label class="form-label">Start Time</label>
                <input type="time" id="startTime" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">End Time</label>
                <input type="time" id="endTime" class="form-input" required>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Event Name</label>
              <input type="text" id="eventName" class="form-input" placeholder="e.g., Birthday Party" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="hasGuests">
                I will have guests
              </label>
            </div>
            <div id="guestCountDiv" style="display: none;">
              <div class="form-group">
                <label class="form-label">Number of Guests</label>
                <input type="number" id="guestCount" class="form-input" min="0">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="noFundraising" checked>
                No fundraising or commercial activity
              </label>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Reservation</button>
          </form>
        </div>
        
        <!-- Your Reservations -->
        <h2 class="section-heading">Your Reservations</h2>
        <div id="reservationsList" class="card">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-text">No reservations yet</div>
          </div>
        </div>

        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>
      </div>
      
      <!-- ========================================================== -->
      <!-- PAGE: PROFILE                                              -->
      <!-- View and edit member profile information                  -->
      <!-- ========================================================== -->
      <div id="profile" class="page">
        <h1 class="page-title">Profile</h1>
        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>

<!-- ============================================================ -->
<!-- PHONE NUMBER EDIT FORM                                        -->
<!-- Simple country dropdown + phone number inputs                 -->
<!-- ============================================================ -->

<div class="card">
  <div class="card-header">
    <h2 class="card-title">Phone Numbers</h2>
  </div>

  <div style="padding: 20px;">
    <!-- Primary Phone -->
    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Primary Phone</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div class="form-group">
        <label class="form-label">Country</label>
        <select id="countryPrimary" class="form-input" onchange="updateCountryFlag('primary')">
          <option value="">-- Select Country --</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Phone Number</label>
        <input id="phonePrimary"
               type="tel"
               class="form-input"
               placeholder="e.g., 71234567">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">
        <input type="checkbox" id="phonePrimaryWhatsApp">
        This number is on WhatsApp
      </label>
    </div>

    <!-- Secondary Phone (optional) -->
    <h3 style="font-size: 14px; font-weight: 600; margin: 20px 0 12px 0;">Secondary Phone (Optional)</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div class="form-group">
        <label class="form-label">Country</label>
        <select id="countrySecondary" class="form-input" onchange="updateCountryFlag('secondary')">
          <option value="">-- Select Country --</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Phone Number</label>
        <input id="phoneSecondary"
               type="tel"
               class="form-input"
               placeholder="e.g., 71234567">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">
        <input type="checkbox" id="phoneSecondaryWhatsApp">
        This number is on WhatsApp
      </label>
    </div>

    <!-- Save Button -->
    <button type="button"
            class="btn btn-primary"
            onclick="savePhoneNumbers()"
            style="margin-top: 16px;">
      Save Phone Numbers
    </button>

    <div id="phoneMessage"
         style="margin-top: 12px; padding: 12px; border-radius: 4px;
                font-size: 13px; display: none;"></div>
  </div>
</div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Personal Information</h2>
          </div>
          <div id="profileContent">
            <p style="text-align: center; color: #999; padding: 20px;">Loading...</p>
          </div>
        </div>

        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>
      </div>

      <!-- ========================================================== -->
      <!-- PAGE: CARD                                                 -->
      <!-- Digital membership card display                            -->
      <!-- ========================================================== -->
      <div id="card" class="page">
        <h1 class="page-title">Digital Membership Card</h1>
        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>

        <div id="cardContent">
          <p style="text-align: center; color: #999; padding: 20px;">Loading...</p>
        </div>

        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>
      </div>

      <!-- ========================================================== -->
      <!-- PAGE: PAYMENT                                              -->
      <!-- Submit payment confirmation                               -->
      <!-- ========================================================== -->
      <div id="payment" class="page">
        <h1 class="page-title">Submit Payment</h1>
        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>

        <div class="info-box">
          üìß Payment submissions are verified by the board. You'll receive email confirmation once your payment is confirmed.
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Payment Information</h2>
          </div>
          <form onsubmit="submitPayment(event)">
            <div class="form-group">
              <label class="form-label">Payment Method</label>
              <select id="paymentMethod" class="form-input" required>
                <option value="">-- Select payment method --</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
                <option value="Check">Check</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Payment Reference</label>
              <input type="text" id="paymentReference" class="form-input" placeholder="e.g., Receipt number, transaction ID" required>
            </div>
            <div class="form-group">
              <label class="form-label">Payment Date</label>
              <input type="date" id="paymentDate" class="form-input" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label class="form-label">Amount (USD)</label>
                <input type="number" id="amountUSD" class="form-input" min="0" step="0.01" placeholder="0.00">
              </div>
              <div class="form-group">
                <label class="form-label">Amount (BWP)</label>
                <input type="number" id="amountBWP" class="form-input" min="0" step="0.01" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notes (optional)</label>
              <textarea id="paymentNotes" class="form-input" placeholder="Any additional information..." style="resize: vertical; min-height: 80px;"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Payment</button>
          </form>
        </div>

        <a class="back-to-dashboard" onclick="showPage('dashboard'); return false;">‚Üê Back to Dashboard</a>
      </div>

    </div>
  </div>
</div>

<script>
  // ============================================================ //
  // SECTION: INITIALIZATION AND STATE                            //
  // ============================================================ //
  
  // The backend API URL is injected when this file is served via Apps Script
  // Using @HEAD deployment for automatic updates on every push
  var PORTAL_API_URL = 'https://script.google.com/a/macros/geabotswana.org/s/AKfycbzIS2NMUsEsp6drBGmWf8YDH44BXNa9g6nbvVOu-fg/exec';

  // Current authentication token
  var currentToken = sessionStorage.getItem('gea_token') || null;
  
  // Current user's email and role
  var currentUser = null;
  
  /**
   * Initialize the member portal when the page loads.
   * Check for existing session token; show login or dashboard accordingly.
   */
  window.addEventListener('load', function() {
    if (currentToken) {
      showAuthenticatedUI();
      loadDashboard();
    } else {
      document.getElementById('loginScreen').classList.add('show');
    }
  });
  
// ============================================================
// SECTION: PHONE NUMBER INPUT WITH intl-tel-input
// ============================================================
// Initializes intl-tel-input on phone input fields for elegant
// international phone number handling. Allows users to select
// their country via flag dropdown and validates format.
// ============================================================

/**
 * Country list with dial codes - Botswana and USA at top, then alphabetical
 */
var COUNTRY_DIAL_CODES = [
  { code: "BW", name: "Botswana", dial: "267" },
  { code: "US", name: "United States", dial: "1" },
  { code: "AF", name: "Afghanistan", dial: "93" },
  { code: "AL", name: "Albania", dial: "355" },
  { code: "DZ", name: "Algeria", dial: "213" },
  { code: "AS", name: "American Samoa", dial: "684" },
  { code: "AD", name: "Andorra", dial: "376" },
  { code: "AO", name: "Angola", dial: "244" },
  { code: "AI", name: "Anguilla", dial: "1" },
  { code: "AQ", name: "Antarctica", dial: "672" },
  { code: "AG", name: "Antigua and Barbuda", dial: "1" },
  { code: "AR", name: "Argentina", dial: "54" },
  { code: "AM", name: "Armenia", dial: "374" },
  { code: "AW", name: "Aruba", dial: "297" },
  { code: "AU", name: "Australia", dial: "61" },
  { code: "AT", name: "Austria", dial: "43" },
  { code: "AZ", name: "Azerbaijan", dial: "994" },
  { code: "BS", name: "Bahamas", dial: "1" },
  { code: "BH", name: "Bahrain", dial: "973" },
  { code: "BD", name: "Bangladesh", dial: "880" },
  { code: "BB", name: "Barbados", dial: "1" },
  { code: "BY", name: "Belarus", dial: "375" },
  { code: "BE", name: "Belgium", dial: "32" },
  { code: "BZ", name: "Belize", dial: "501" },
  { code: "BJ", name: "Benin", dial: "229" },
  { code: "BM", name: "Bermuda", dial: "1" },
  { code: "BT", name: "Bhutan", dial: "975" },
  { code: "BO", name: "Bolivia", dial: "591" },
  { code: "BA", name: "Bosnia and Herzegovina", dial: "387" },
  { code: "BR", name: "Brazil", dial: "55" },
  { code: "BN", name: "Brunei", dial: "673" },
  { code: "BG", name: "Bulgaria", dial: "359" },
  { code: "BF", name: "Burkina Faso", dial: "226" },
  { code: "BI", name: "Burundi", dial: "257" },
  { code: "KH", name: "Cambodia", dial: "855" },
  { code: "CM", name: "Cameroon", dial: "237" },
  { code: "CA", name: "Canada", dial: "1" },
  { code: "CV", name: "Cape Verde", dial: "238" },
  { code: "KY", name: "Cayman Islands", dial: "1" },
  { code: "CF", name: "Central African Republic", dial: "236" },
  { code: "TD", name: "Chad", dial: "235" },
  { code: "CL", name: "Chile", dial: "56" },
  { code: "CN", name: "China", dial: "86" },
  { code: "CO", name: "Colombia", dial: "57" },
  { code: "KM", name: "Comoros", dial: "269" },
  { code: "CG", name: "Congo", dial: "242" },
  { code: "CR", name: "Costa Rica", dial: "506" },
  { code: "HR", name: "Croatia", dial: "385" },
  { code: "CU", name: "Cuba", dial: "53" },
  { code: "CY", name: "Cyprus", dial: "357" },
  { code: "CZ", name: "Czech Republic", dial: "420" },
  { code: "DK", name: "Denmark", dial: "45" },
  { code: "DJ", name: "Djibouti", dial: "253" },
  { code: "DM", name: "Dominica", dial: "1" },
  { code: "DO", name: "Dominican Republic", dial: "1" },
  { code: "EC", name: "Ecuador", dial: "593" },
  { code: "EG", name: "Egypt", dial: "20" },
  { code: "SV", name: "El Salvador", dial: "503" },
  { code: "GQ", name: "Equatorial Guinea", dial: "240" },
  { code: "ER", name: "Eritrea", dial: "291" },
  { code: "EE", name: "Estonia", dial: "372" },
  { code: "ET", name: "Ethiopia", dial: "251" },
  { code: "FJ", name: "Fiji", dial: "679" },
  { code: "FI", name: "Finland", dial: "358" },
  { code: "FR", name: "France", dial: "33" },
  { code: "GF", name: "French Guiana", dial: "594" },
  { code: "PF", name: "French Polynesia", dial: "689" },
  { code: "GA", name: "Gabon", dial: "241" },
  { code: "GM", name: "Gambia", dial: "220" },
  { code: "GE", name: "Georgia", dial: "995" },
  { code: "DE", name: "Germany", dial: "49" },
  { code: "GH", name: "Ghana", dial: "233" },
  { code: "GI", name: "Gibraltar", dial: "350" },
  { code: "GR", name: "Greece", dial: "30" },
  { code: "GL", name: "Greenland", dial: "299" },
  { code: "GD", name: "Grenada", dial: "1" },
  { code: "GP", name: "Guadeloupe", dial: "590" },
  { code: "GU", name: "Guam", dial: "1" },
  { code: "GT", name: "Guatemala", dial: "502" },
  { code: "GG", name: "Guernsey", dial: "44" },
  { code: "GN", name: "Guinea", dial: "224" },
  { code: "GW", name: "Guinea-Bissau", dial: "245" },
  { code: "GY", name: "Guyana", dial: "592" },
  { code: "HT", name: "Haiti", dial: "509" },
  { code: "HN", name: "Honduras", dial: "504" },
  { code: "HK", name: "Hong Kong", dial: "852" },
  { code: "HU", name: "Hungary", dial: "36" },
  { code: "IS", name: "Iceland", dial: "354" },
  { code: "IN", name: "India", dial: "91" },
  { code: "ID", name: "Indonesia", dial: "62" },
  { code: "IR", name: "Iran", dial: "98" },
  { code: "IQ", name: "Iraq", dial: "964" },
  { code: "IE", name: "Ireland", dial: "353" },
  { code: "IM", name: "Isle of Man", dial: "44" },
  { code: "IL", name: "Israel", dial: "972" },
  { code: "IT", name: "Italy", dial: "39" },
  { code: "JM", name: "Jamaica", dial: "1" },
  { code: "JP", name: "Japan", dial: "81" },
  { code: "JE", name: "Jersey", dial: "44" },
  { code: "JO", name: "Jordan", dial: "962" },
  { code: "KZ", name: "Kazakhstan", dial: "7" },
  { code: "KE", name: "Kenya", dial: "254" },
  { code: "KI", name: "Kiribati", dial: "686" },
  { code: "KP", name: "North Korea", dial: "850" },
  { code: "KR", name: "South Korea", dial: "82" },
  { code: "KW", name: "Kuwait", dial: "965" },
  { code: "KG", name: "Kyrgyzstan", dial: "996" },
  { code: "LA", name: "Laos", dial: "856" },
  { code: "LV", name: "Latvia", dial: "371" },
  { code: "LB", name: "Lebanon", dial: "961" },
  { code: "LS", name: "Lesotho", dial: "266" },
  { code: "LR", name: "Liberia", dial: "231" },
  { code: "LY", name: "Libya", dial: "218" },
  { code: "LI", name: "Liechtenstein", dial: "423" },
  { code: "LT", name: "Lithuania", dial: "370" },
  { code: "LU", name: "Luxembourg", dial: "352" },
  { code: "MO", name: "Macao", dial: "853" },
  { code: "MK", name: "Macedonia", dial: "389" },
  { code: "MG", name: "Madagascar", dial: "261" },
  { code: "MW", name: "Malawi", dial: "265" },
  { code: "MY", name: "Malaysia", dial: "60" },
  { code: "MV", name: "Maldives", dial: "960" },
  { code: "ML", name: "Mali", dial: "223" },
  { code: "MT", name: "Malta", dial: "356" },
  { code: "MH", name: "Marshall Islands", dial: "692" },
  { code: "MQ", name: "Martinique", dial: "596" },
  { code: "MR", name: "Mauritania", dial: "222" },
  { code: "MU", name: "Mauritius", dial: "230" },
  { code: "MX", name: "Mexico", dial: "52" },
  { code: "FM", name: "Micronesia", dial: "691" },
  { code: "MD", name: "Moldova", dial: "373" },
  { code: "MC", name: "Monaco", dial: "377" },
  { code: "MN", name: "Mongolia", dial: "976" },
  { code: "ME", name: "Montenegro", dial: "382" },
  { code: "MA", name: "Morocco", dial: "212" },
  { code: "MZ", name: "Mozambique", dial: "258" },
  { code: "MM", name: "Myanmar", dial: "95" },
  { code: "NA", name: "Namibia", dial: "264" },
  { code: "NR", name: "Nauru", dial: "674" },
  { code: "NP", name: "Nepal", dial: "977" },
  { code: "NL", name: "Netherlands", dial: "31" },
  { code: "AN", name: "Netherlands Antilles", dial: "599" },
  { code: "NC", name: "New Caledonia", dial: "687" },
  { code: "NZ", name: "New Zealand", dial: "64" },
  { code: "NI", name: "Nicaragua", dial: "505" },
  { code: "NE", name: "Niger", dial: "227" },
  { code: "NG", name: "Nigeria", dial: "234" },
  { code: "NU", name: "Niue", dial: "683" },
  { code: "NF", name: "Norfolk Island", dial: "672" },
  { code: "MP", name: "Northern Mariana Islands", dial: "1" },
  { code: "NO", name: "Norway", dial: "47" },
  { code: "OM", name: "Oman", dial: "968" },
  { code: "PK", name: "Pakistan", dial: "92" },
  { code: "PW", name: "Palau", dial: "680" },
  { code: "PA", name: "Panama", dial: "507" },
  { code: "PG", name: "Papua New Guinea", dial: "675" },
  { code: "PY", name: "Paraguay", dial: "595" },
  { code: "PE", name: "Peru", dial: "51" },
  { code: "PH", name: "Philippines", dial: "63" },
  { code: "PL", name: "Poland", dial: "48" },
  { code: "PT", name: "Portugal", dial: "351" },
  { code: "PR", name: "Puerto Rico", dial: "1" },
  { code: "QA", name: "Qatar", dial: "974" },
  { code: "RE", name: "Reunion", dial: "262" },
  { code: "RO", name: "Romania", dial: "40" },
  { code: "RU", name: "Russia", dial: "7" },
  { code: "RW", name: "Rwanda", dial: "250" },
  { code: "SH", name: "Saint Helena", dial: "290" },
  { code: "KN", name: "Saint Kitts and Nevis", dial: "1" },
  { code: "LC", name: "Saint Lucia", dial: "1" },
  { code: "PM", name: "Saint Pierre and Miquelon", dial: "508" },
  { code: "VC", name: "Saint Vincent and the Grenadines", dial: "1" },
  { code: "WS", name: "Samoa", dial: "685" },
  { code: "SM", name: "San Marino", dial: "378" },
  { code: "ST", name: "Sao Tome and Principe", dial: "239" },
  { code: "SA", name: "Saudi Arabia", dial: "966" },
  { code: "SN", name: "Senegal", dial: "221" },
  { code: "RS", name: "Serbia", dial: "381" },
  { code: "SC", name: "Seychelles", dial: "248" },
  { code: "SL", name: "Sierra Leone", dial: "232" },
  { code: "SG", name: "Singapore", dial: "65" },
  { code: "SK", name: "Slovakia", dial: "421" },
  { code: "SI", name: "Slovenia", dial: "386" },
  { code: "SB", name: "Solomon Islands", dial: "677" },
  { code: "SO", name: "Somalia", dial: "252" },
  { code: "ZA", name: "South Africa", dial: "27" },
  { code: "SS", name: "South Sudan", dial: "211" },
  { code: "ES", name: "Spain", dial: "34" },
  { code: "LK", name: "Sri Lanka", dial: "94" },
  { code: "SD", name: "Sudan", dial: "249" },
  { code: "SR", name: "Suriname", dial: "597" },
  { code: "SZ", name: "Swaziland", dial: "268" },
  { code: "SE", name: "Sweden", dial: "46" },
  { code: "CH", name: "Switzerland", dial: "41" },
  { code: "SY", name: "Syria", dial: "963" },
  { code: "TW", name: "Taiwan", dial: "886" },
  { code: "TJ", name: "Tajikistan", dial: "992" },
  { code: "TZ", name: "Tanzania", dial: "255" },
  { code: "TH", name: "Thailand", dial: "66" },
  { code: "TL", name: "Timor-Leste", dial: "670" },
  { code: "TG", name: "Togo", dial: "228" },
  { code: "TK", name: "Tokelau", dial: "690" },
  { code: "TO", name: "Tonga", dial: "676" },
  { code: "TT", name: "Trinidad and Tobago", dial: "1" },
  { code: "TN", name: "Tunisia", dial: "216" },
  { code: "TR", name: "Turkey", dial: "90" },
  { code: "TM", name: "Turkmenistan", dial: "993" },
  { code: "TC", name: "Turks and Caicos Islands", dial: "1" },
  { code: "TV", name: "Tuvalu", dial: "688" },
  { code: "UG", name: "Uganda", dial: "256" },
  { code: "UA", name: "Ukraine", dial: "380" },
  { code: "AE", name: "United Arab Emirates", dial: "971" },
  { code: "GB", name: "United Kingdom", dial: "44" },
  { code: "UY", name: "Uruguay", dial: "598" },
  { code: "UZ", name: "Uzbekistan", dial: "998" },
  { code: "VU", name: "Vanuatu", dial: "678" },
  { code: "VE", name: "Venezuela", dial: "58" },
  { code: "VN", name: "Vietnam", dial: "84" },
  { code: "VG", name: "Virgin Islands (British)", dial: "1" },
  { code: "VI", name: "Virgin Islands (US)", dial: "1" },
  { code: "WF", name: "Wallis and Futuna", dial: "681" },
  { code: "EH", name: "Western Sahara", dial: "212" },
  { code: "YE", name: "Yemen", dial: "967" },
  { code: "ZM", name: "Zambia", dial: "260" },
  { code: "ZW", name: "Zimbabwe", dial: "263" }
];

/**
 * Initialize phone form - populate country dropdowns
 */
function initPhoneForm() {
  // Populate country dropdowns
  populateCountryDropdown("countryPrimary");
  populateCountryDropdown("countrySecondary");
}

/**
 * Populate a country dropdown with all countries
 */
function populateCountryDropdown(selectId) {
  var select = document.getElementById(selectId);
  if (!select) return;

  // Clear existing options except the first one
  while (select.options.length > 1) {
    select.remove(1);
  }

  // Add countries
  COUNTRY_DIAL_CODES.forEach(function(country) {
    var option = document.createElement("option");
    option.value = country.code;
    option.textContent = country.name + " (+" + country.dial + ")";
    select.appendChild(option);
  });
}

/**
 * Placeholder for country flag update (not needed with simple dropdowns)
 */
function updateCountryFlag(fieldType) {
  // No-op for now - just a placeholder
}

/**
 * Saves phone numbers to the backend via API call.
 * Validates data before sending, shows success/error message.
 */
function savePhoneNumbers() {
  // Get values from form inputs
  var countryCodePrimary = document.getElementById("countryPrimary").value;
  var phoneNumberPrimary = document.getElementById("phonePrimary").value.replace(/[^\d]/g, "");
  var phonePrimaryWhatsApp = document.getElementById("phonePrimaryWhatsApp").checked;

  var countryCodeSecondary = document.getElementById("countrySecondary").value;
  var phoneNumberSecondary = document.getElementById("phoneSecondary").value.replace(/[^\d]/g, "");
  var phoneSecondaryWhatsApp = document.getElementById("phoneSecondaryWhatsApp").checked;

  // Validate primary phone is provided
  if (!countryCodePrimary || !phoneNumberPrimary) {
    showPhoneMessage("Please enter your primary phone number and select a country.", "error");
    return;
  }

  // Show loading state
  var btn = document.querySelector('button[onclick="savePhoneNumbers()"]');
  var originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Saving...";

  // Call backend API to save phone numbers
  apiCall("updatePhoneNumbers", {
    country_code_primary: countryCodePrimary,
    phone_primary: phoneNumberPrimary,
    phone_primary_whatsapp: phonePrimaryWhatsApp,
    country_code_secondary: countryCodeSecondary,
    phone_secondary: phoneNumberSecondary,
    phone_secondary_whatsapp: phoneSecondaryWhatsApp
  }).then(function(res) {
    btn.disabled = false;
    btn.textContent = originalText;

    if (!res.success) {
      showPhoneMessage("Error: " + res.message, "error");
      return;
    }

    showPhoneMessage("‚úì Phone numbers saved successfully!", "success");

    // Reload profile data after save
    setTimeout(function() {
      loadProfile();
    }, 1000);

  }).catch(function(err) {
    btn.disabled = false;
    btn.textContent = originalText;
    showPhoneMessage("Connection error. Please try again.", "error");
    console.error("Phone save error:", err);
  });
}

/**
 * Displays a success or error message below the phone form.
 * 
 * @param {string} message  Message text to display
 * @param {string} type     "success" or "error"
 */
function showPhoneMessage(message, type) {
  var msgDiv = document.querySelector("#phoneMessage");
  if (!msgDiv) return;
  
  msgDiv.textContent = message;
  msgDiv.style.display = "block";
  
  if (type === "success") {
    msgDiv.style.background = "#F1F8E9";
    msgDiv.style.borderLeft = "5px solid #2E7D32";
    msgDiv.style.color = "#2E7D32";
  } else {
    msgDiv.style.background = "#FFEBEE";
    msgDiv.style.borderLeft = "5px solid #C62828";
    msgDiv.style.color = "#C62828";
  }
}

// Initialize phone inputs when profile page loads
// Add to the loadProfile() function:
// (At the end of loadProfile(), after rendering, add:)
// setTimeout(function() { initPhoneInputs(); }, 500);

  // ============================================================ //
  // SECTION: AUTHENTICATION                                      //
  // ============================================================ //
  
/**
 * Submits the login form to authenticate the user.
 * Now requires both email and password.
 * Calls the backend login action with both credentials.
 * On success, stores the session token and shows the member interface.
 * On failure, displays an error message below the login form.
 */
function submitLogin(event) {
  event.preventDefault();
  
  // Get email and password from the form
  var email = document.getElementById('loginEmail').value.trim().toLowerCase();
  var password = document.getElementById('loginPassword').value;
  
  // Clear any previous error messages
  var errorDiv = document.getElementById('loginError');
  errorDiv.textContent = '';
  errorDiv.classList.remove('show');
  
  // Validate password length on the frontend (user-friendly error)
  if (password.length < 12) {
    errorDiv.textContent = 'Password must be at least 12 characters.';
    errorDiv.classList.add('show');
    return;
  }
  
  // Disable the submit button while the request is in progress
  var submitBtn = event.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Signing in...';
  
  // Call the backend login action with BOTH email and password
  apiCall('login', { 
    email: email,
    password: password  // ‚Üê NEW: password is now sent
  }).then(function(res) {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Sign In';
    
    console.log("LOGIN RESPONSE:", res);
    
    if (!res.success) {
      // Login failed ‚Äî show error message
      // Generic message for security (don't reveal if email/password/status is wrong)
      errorDiv.textContent = res.message || 'Invalid email or password.';
      errorDiv.classList.add('show');
      return;
    }
    
    // Login successful ‚Äî store the token and show the app
    currentToken = res.data.token;
    currentUser = res.data;
    sessionStorage.setItem('gea_token', currentToken);
    
    // Hide login and show the authenticated interface
    document.getElementById('loginScreen').classList.remove('show');
    showAuthenticatedUI();
    loadDashboard();
  }).catch(function(err) {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Sign In';
    errorDiv.textContent = 'Connection error. Please try again.';
    errorDiv.classList.add('show');
    console.error('Login error:', err);
  });
} 

  /**
   * Shows the authenticated member interface (header, content).
   * Sets the user's name and household name in the header.
   */
  function showAuthenticatedUI() {
    // Hide login screen
    document.getElementById('loginScreen').classList.remove('show');

    // Show header and content
    document.getElementById('header').style.display = 'flex';
    document.getElementById('content').style.display = 'flex';

    // Set the member's name and household in the header from the login response data
    if (currentUser && currentUser.member) {
      // Display member's full name (first_name + last_name from Individuals table)
      var memberData = currentUser.member;
      var memberName = memberData.first_name && memberData.last_name
        ? memberData.first_name + ' ' + memberData.last_name
        : memberData.email.split('@')[0];
      document.getElementById('headerUserName').textContent = memberName;

      // Display household name from Households table
      var householdName = memberData.household_name || 'Household';
      document.getElementById('headerHouseholdName').textContent = householdName;
    }
  }
  
  /**
   * Logs out the current user.
   * Clears the session token and returns to the login screen.
   */
  function logout() {
    sessionStorage.removeItem('gea_token');
    currentToken = null;
    currentUser = null;
    
    // Hide authenticated UI
    document.getElementById('header').style.display = 'none';
    document.getElementById('content').style.display = 'none';
    
    // Show and reset login screen
    document.getElementById('loginScreen').classList.add('show');
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginError').classList.remove('show');
  }
  
  // ============================================================ //
  // SECTION: API COMMUNICATION                                   //
  // ============================================================ //
  
  /**
   * Makes an API call to the backend Apps Script.
   * Uses google.script.run for secure client-server communication.
   * Automatically includes the session token.
   */
  function apiCall(action, params) {
    params = params || {};
    params.action = action;
    params.token = currentToken || '';

    // Return a promise that uses google.script.run
    return new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(function(response) {
          // Parse the response if it's a string (should be JSON)
          if (typeof response === 'string') {
            try {
              resolve(JSON.parse(response));
            } catch (e) {
              reject(new Error('Invalid JSON response: ' + response));
            }
          } else {
            resolve(response);
          }
        })
        .withFailureHandler(function(error) {
          reject(new Error('Server error: ' + error));
        })
        .handlePortalApi(action, params);
    });
  }
  
  // ============================================================ //
  // SECTION: PAGE NAVIGATION                                     //
  // ============================================================ //
  
  /**
   * Switches to a different member page (dashboard, reservations, etc.).
   * Hides all pages except the one specified and loads fresh data.
   */
  function showPage(pageName) {
    // Hide all pages
    var pages = document.querySelectorAll('.page');
    pages.forEach(function(page) {
      page.classList.remove('active');
    });
    
    // Show the requested page
    var targetPage = document.getElementById(pageName);
    if (targetPage) {
      targetPage.classList.add('active');
    }
    
    // Load data for the requested page
    switch (pageName) {
      case 'dashboard':
        loadDashboard();
        break;
      case 'reservations':
        loadReservations();
        break;
      case 'profile':
        loadProfile();
        break;
      case 'card':
        loadCard();
        break;
      case 'payment':
        // Payment page doesn't need to load data
        break;
    }
    
    // Scroll to top
    window.scrollTo(0, 0);
  }
  
  // ============================================================ //
  // SECTION: DASHBOARD                                           //
  // ============================================================ //
  
  /**
   * Loads the dashboard with membership status and household info.
   */
  function docStatusIcon(status) {
    var map = {
      'verified': '‚úÖ',
      'submitted': '‚è≥',
      'rso_approved': '‚è≥',
      'gea_pending': '‚è≥',
      'rso_rejected': '‚ùå',
      'gea_rejected': '‚ùå',
      'none': '‚Äî',
      '': '‚Äî'
    };
    return map[status] || '‚Äî';
  }

  function renderAlerts(data) {
    var hh = data.household;
    var members = data.members || [];
    var alerts = [];

    // Calculate days until expiry
    var expiryDate = hh && hh.membership_expiration_date ? new Date(hh.membership_expiration_date) : null;
    var today = new Date();
    var daysUntilExpiry = expiryDate ? Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24)) : null;

    // DANGER: Inactive membership
    if (hh && !hh.active) {
      alerts.push({
        type: 'danger',
        message: 'Membership inactive. Please contact board@geabotswana.org to reactivate.'
      });
    }

    // DANGER: Outstanding dues
    if (hh && hh.balance_due_usd > 0) {
      alerts.push({
        type: 'danger',
        message: 'Dues outstanding: $' + hh.balance_due_usd.toFixed(2) + '. <a href="#" onclick="showPage(\'payment\'); return false;" style="color: inherit; text-decoration: underline;">Submit payment</a>'
      });
    }

    // WARNING: Membership expires soon
    if (daysUntilExpiry !== null && daysUntilExpiry <= 30 && daysUntilExpiry > 0) {
      alerts.push({
        type: 'warning',
        message: 'Membership expires in ' + daysUntilExpiry + ' days. Renew soon to avoid interruption.'
      });
    }

    // WARNING: Profile photo needed
    if (data.photoRequired) {
      alerts.push({
        type: 'warning',
        message: 'Profile photo required. <a href="#" onclick="showPage(\'profile\'); return false;" style="color: inherit; text-decoration: underline;">Upload now</a>'
      });
    }

    // WARNING: Rejected documents
    members.forEach(function(m) {
      if (m.passport_status === 'rso_rejected' || m.passport_status === 'gea_rejected') {
        alerts.push({
          type: 'warning',
          message: m.first_name + ' ' + m.last_name + '\'s passport was rejected. <a href="#" onclick="showPage(\'profile\'); return false;" style="color: inherit; text-decoration: underline;">Re-upload</a>'
        });
      }
      if (m.omang_status === 'rso_rejected' || m.omang_status === 'gea_rejected') {
        alerts.push({
          type: 'warning',
          message: m.first_name + ' ' + m.last_name + '\'s ID was rejected. <a href="#" onclick="showPage(\'profile\'); return false;" style="color: inherit; text-decoration: underline;">Re-upload</a>'
        });
      }
    });

    // INFO: Documents under review
    members.forEach(function(m) {
      if (m.passport_status === 'submitted' || m.passport_status === 'rso_approved' || m.passport_status === 'gea_pending') {
        alerts.push({
          type: 'info',
          message: m.first_name + ' ' + m.last_name + '\'s passport is under review.'
        });
      }
      if (m.omang_status === 'submitted' || m.omang_status === 'rso_approved' || m.omang_status === 'gea_pending') {
        alerts.push({
          type: 'info',
          message: m.first_name + ' ' + m.last_name + '\'s ID is under review.'
        });
      }
    });

    // Render alerts
    var alertsHtml = '';
    alerts.forEach(function(alert) {
      alertsHtml += '<div class="alert-banner alert-banner-' + alert.type + '">' +
        '<div class="alert-banner-text">' + alert.message + '</div>' +
        '<button class="alert-banner-close" onclick="this.parentElement.style.display=\'none\';">‚úï</button>' +
        '</div>';
    });

    document.getElementById('alertBanners').innerHTML = alertsHtml;
  }

  function renderMembershipCard(hh, level, exchangeRate) {
    if (!hh) {
      document.getElementById('membershipCard').innerHTML = '<p style="text-align: center; color: #999;">Unable to load membership data.</p>';
      return;
    }

    var expiryDate = hh.membership_expiration_date ? new Date(hh.membership_expiration_date) : null;
    var today = new Date();
    var daysUntilExpiry = expiryDate ? Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24)) : null;
    var expiryStatus = daysUntilExpiry === null ? '' : (daysUntilExpiry <= 0 ? ' (Expired)' : ' (' + daysUntilExpiry + ' days remaining)');
    var expiryColor = daysUntilExpiry !== null && daysUntilExpiry < 30 ? 'color: var(--color-danger);' : 'color: var(--color-success);';

    var balanceClass = hh.balance_due_usd > 0 ? 'negative' : 'positive';

    var html = '<div>' +
      '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
      '<h3 style="margin: 0; color: #333;">' + hh.household_name + '</h3>' +
      '<div><span class="badge badge-' + (hh.active ? 'approved' : 'cancelled') + '">' + (hh.active ? 'ACTIVE' : 'INACTIVE') + '</span></div>' +
      '</div>' +
      (level ? '<div style="font-size: 13px; color: #666; margin-bottom: 16px;">' + level.level_name + '</div>' : '') +
      '<div style="margin-bottom: 16px;">' +
      '<div style="' + expiryColor + 'font-size: 14px; font-weight: 600;">' + hh.membership_expiration_date + expiryStatus + '</div>' +
      '<div style="font-size: 12px; color: #999; margin-top: 4px;">Member since ' + hh.membership_start_date + '</div>' +
      '</div>' +
      '<div class="dues-grid">' +
      '<div class="dues-row"><div class="dues-label">Annual Dues</div><div class="dues-value">$' + hh.dues_amount_usd.toFixed(2) + '</div></div>' +
      '<div class="dues-row"><div class="dues-label">Amount Paid</div><div class="dues-value">$' + hh.dues_paid_amount_usd.toFixed(2) + '</div></div>' +
      '<div class="dues-row"><div class="dues-label">Balance Due</div><div class="dues-value ' + balanceClass + '">$' + hh.balance_due_usd.toFixed(2) + '</div></div>' +
      '</div>';

    if (hh.sponsor_name) {
      html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0;">' +
        '<div style="font-size: 12px; color: #999; text-transform: uppercase; font-weight: 600;">Sponsor</div>' +
        '<div style="font-size: 14px; margin-top: 4px;">' + hh.sponsor_name +
        (hh.sponsor_verified ? ' <span class="privilege-badge privilege-yes">‚úì Verified</span>' : '') +
        '</div></div>';
    }

    // Contact Information
    if (hh.address_street || hh.phone_primary) {
      html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0;">' +
        '<div style="font-size: 12px; color: #999; text-transform: uppercase; font-weight: 600;">Contact Information</div>';

      if (hh.address_street || hh.address_city || hh.address_country) {
        html += '<div style="font-size: 13px; margin-top: 8px; line-height: 1.5;">' +
          (hh.address_street ? hh.address_street + '<br/>' : '') +
          (hh.address_city ? hh.address_city + ', ' : '') +
          (hh.address_country ? hh.address_country : '') +
          '</div>';
      }

      if (hh.phone_primary) {
        var phoneDisplay = (hh.country_code_primary ? hh.country_code_primary + ' ' : '') + hh.phone_primary;
        html += '<div style="font-size: 13px; margin-top: 8px;">' + phoneDisplay +
          (hh.phone_primary_whatsapp ? ' <span style="font-size: 11px; color: #25D366; font-weight: 600;">WhatsApp</span>' : '') +
          '</div>';
      } else {
        html += '<div style="font-size: 13px; margin-top: 8px; color: #999; font-style: italic;">no phone provided</div>';
      }

      html += '</div>';
    }

    html += '<div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">';
    if (level) {
      html += '<span class="privilege-badge ' + (level.voting_rights ? 'privilege-yes' : 'privilege-no') + '">' +
        (level.voting_rights ? '‚úì' : '‚úó') + ' Voting Rights</span>';
      html += '<span class="privilege-badge ' + (level.office_eligible ? 'privilege-yes' : 'privilege-no') + '">' +
        (level.office_eligible ? '‚úì' : '‚úó') + ' Office Eligible</span>';
    }
    html += '</div></div>';

    document.getElementById('membershipCard').innerHTML = html;
  }

  function renderHouseholdMembers(members) {
    if (!members || members.length === 0) {
      document.getElementById('householdMembers').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No household members listed.</p>';
      return;
    }

    var html = '<table class="household-table"><thead><tr>' +
      '<th>Name</th>' +
      '<th>Role</th>' +
      '<th>Photo</th>' +
      '<th>Passport</th>' +
      '<th>ID</th>' +
      '</tr></thead><tbody>';

    members.forEach(function(m) {
      html += '<tr>' +
        '<td>' + m.first_name + ' ' + m.last_name + '</td>' +
        '<td>' + (m.relationship_to_primary || 'N/A') + '</td>' +
        '<td class="doc-status">' + docStatusIcon(m.photo_status) + '</td>' +
        '<td class="doc-status">' + docStatusIcon(m.passport_status) + '</td>' +
        '<td class="doc-status">' + docStatusIcon(m.omang_status) + '</td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('householdMembers').innerHTML = html;
  }

  function renderReservations(reservations) {
    if (!reservations || reservations.length === 0) {
      document.getElementById('upcomingReservations').innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üìÖ</div>' +
        '<div class="empty-state-text">No upcoming reservations</div>' +
        '</div>';
      return;
    }

    var html = '<table class="reservations-table"><thead><tr>' +
      '<th>Date</th>' +
      '<th>Facility</th>' +
      '<th>Time</th>' +
      '<th>Status</th>' +
      '<th></th>' +
      '</tr></thead><tbody>';

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    reservations.forEach(function(res) {
      var resDate = new Date(res.event_date);
      var isFuture = resDate >= today;
      var cancelBtn = (isFuture && res.status !== 'Cancelled') ?
        '<button class="cancel-btn-small" onclick="if(confirm(\'Cancel this reservation?\')) cancelReservation(\'' + res.reservation_id + '\');">Cancel</button>' :
        '';

      html += '<tr>' +
        '<td>' + res.event_date + '</td>' +
        '<td>' + res.facility + '</td>' +
        '<td>' + (res.start_time || '‚Äî') + '‚Äì' + (res.end_time || '‚Äî') + '</td>' +
        '<td><span class="badge badge-' + (res.status === 'Confirmed' ? 'confirmed' : 'pending') + '">' + res.status + '</span></td>' +
        '<td>' + cancelBtn + '</td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('upcomingReservations').innerHTML = html;
  }

  function renderQuotas(quotas) {
    var html = '<div>' +
      '<div style="margin-bottom: 24px;">' +
      '<h4 style="margin: 0 0 8px 0; color: #333;">Tennis Court ‚Äî This Week</h4>' +
      '<div style="display: flex; align-items: center; gap: 12px;">' +
      '<div style="flex: 1;">';

    var tennisPct = (quotas.tennis.hours_used / quotas.tennis.hours_limit) * 100;
    var tennisClass = tennisPct >= 80 ? 'warning' : '';
    html += '<div class="quota-bar-container"><div class="quota-bar-fill ' + tennisClass + '" style="width: ' + Math.min(100, tennisPct) + '%;"></div></div>' +
      '<div class="quota-info">' + quotas.tennis.hours_used.toFixed(1) + ' of ' + quotas.tennis.hours_limit + ' hours used</div>' +
      '</div></div></div>';

    html += '<div style="margin-bottom: 24px;">' +
      '<h4 style="margin: 0 0 8px 0; color: #333;">Leobo Lodge ‚Äî This Month</h4>' +
      '<div style="margin-bottom: 12px;">' +
      '<div style="font-size: 12px; color: #666; margin-bottom: 4px;">Bookings</div>';

    var leoboPct = (quotas.leobo.count_used / quotas.leobo.count_limit) * 100;
    var leoboClass = leoboPct >= 80 ? 'warning' : '';
    html += '<div class="quota-bar-container"><div class="quota-bar-fill ' + leoboClass + '" style="width: ' + Math.min(100, leoboPct) + '%;"></div></div>' +
      '<div class="quota-info">' + quotas.leobo.count_used + ' of ' + quotas.leobo.count_limit + ' booking(s) used</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #666; margin-bottom: 4px;">Hours</div>';

    var leoboHoursPct = (quotas.leobo.hours_used / quotas.leobo.hours_limit) * 100;
    var leoboHoursClass = leoboHoursPct >= 80 ? 'warning' : '';
    html += '<div class="quota-bar-container"><div class="quota-bar-fill ' + leoboHoursClass + '" style="width: ' + Math.min(100, leoboHoursPct) + '%;"></div></div>' +
      '<div class="quota-info">' + quotas.leobo.hours_used.toFixed(1) + ' of ' + quotas.leobo.hours_limit + ' hours used</div>' +
      '</div></div></div>';

    document.getElementById('facilityQuotas').innerHTML = html;
  }

  function loadDashboard() {
    apiCall('dashboard', {}).then(function(res) {
      if (!res.success) {
        showError('Failed to load dashboard: ' + res.message);
        return;
      }

      var data = res.data;

      // Update header with current member and household info
      if (data.member) {
        var memberName = data.member.first_name && data.member.last_name
          ? data.member.first_name + ' ' + data.member.last_name
          : data.member.email.split('@')[0];
        document.getElementById('headerUserName').textContent = memberName;
      }
      if (data.household) {
        document.getElementById('headerHouseholdName').textContent = data.household.household_name || 'Household';
      }

      // Render all dashboard components
      renderAlerts(data);
      renderMembershipCard(data.household, data.level, data.exchange_rate);
      renderHouseholdMembers(data.members);
      renderReservations(data.reservations);
      renderQuotas(data.quotas);

      // Render quick action buttons
      var quickActionsHtml = '<div class="quick-actions-grid">' +
        '<button class="quick-action-btn" onclick="showPage(\'reservations\');">' +
        '<div class="quick-action-icon">üìÖ</div>' +
        '<div>Book Facility</div>' +
        '</button>' +
        '<button class="quick-action-btn" onclick="showPage(\'payment\');">' +
        '<div class="quick-action-icon">üí∞</div>' +
        '<div>Submit Payment</div>' +
        '</button>' +
        '<button class="quick-action-btn" onclick="showPage(\'card\');">' +
        '<div class="quick-action-icon">üé´</div>' +
        '<div>Digital Card</div>' +
        '</button>' +
        '<button class="quick-action-btn" onclick="showPage(\'profile\');">' +
        '<div class="quick-action-icon">üë§</div>' +
        '<div>Edit Profile</div>' +
        '</button>' +
        '</div>';
      document.getElementById('quickActionsContainer').innerHTML = quickActionsHtml;
    });
  }
  
  // ============================================================ //
  // SECTION: RESERVATIONS                                        //
  // ============================================================ //
  
  /**
   * Shows the reservations page and loads member's reservation history.
   */
  function loadReservations() {
    // Load the member's past and current reservations
    apiCall('reservations', {}).then(function(res) {
      if (!res.success) {
        showError('Failed to load reservations: ' + res.message);
        return;
      }
      
      var reservations = res.data.reservations || [];
      var html = '';
      
      if (reservations.length === 0) {
        html = '<div class="empty-state">' +
          '<div class="empty-state-icon">üìã</div>' +
          '<div class="empty-state-text">No reservations yet</div>' +
          '</div>';
      } else {
        html = '<table><thead><tr><th>Date</th><th>Facility</th><th>Status</th><th>Action</th></tr></thead><tbody>';
        reservations.forEach(function(res) {
          var canCancel = res.status === 'STATUS_PENDING' || res.status === 'STATUS_CONFIRMED';
          html += '<tr>' +
            '<td>' + res.event_date + '</td>' +
            '<td>' + res.facility + '</td>' +
            '<td><span class="badge badge-' + (res.status === 'STATUS_CONFIRMED' ? 'confirmed' : (res.status === 'STATUS_PENDING' ? 'pending' : 'cancelled')) + '">' + res.status + '</span></td>' +
            '<td>' + (canCancel ? '<button class="btn btn-danger btn-small" onclick="cancelReservation(\'' + res.reservation_id + '\');">Cancel</button>' : '‚Äî') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
      }
      
      document.getElementById('reservationsList').innerHTML = html;
    });
  }
  
  /**
   * Submits a new reservation request.
   */
  function submitReservation(event) {
    event.preventDefault();
    
    var facility = document.getElementById('facility').value;
    var eventDate = document.getElementById('eventDate').value;
    var startTime = document.getElementById('startTime').value;
    var endTime = document.getElementById('endTime').value;
    var eventName = document.getElementById('eventName').value;
    var hasGuests = document.getElementById('hasGuests').checked;
    var guestCount = hasGuests ? parseInt(document.getElementById('guestCount').value) || 0 : 0;
    var noFundraising = document.getElementById('noFundraising').checked;
    
    // Calculate duration
    var start = new Date('2000-01-01T' + startTime);
    var end = new Date('2000-01-01T' + endTime);
    var durationHours = (end - start) / (1000 * 60 * 60);
    
    var btn = event.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    
    apiCall('book', {
      facility: facility,
      event_date: eventDate,
      start_time: eventDate + 'T' + startTime,
      end_time: eventDate + 'T' + endTime,
      duration_hours: durationHours,
      event_name: eventName,
      has_guests: hasGuests,
      guest_count: guestCount,
      no_fundraising: noFundraising
    }).then(function(res) {
      btn.disabled = false;
      btn.textContent = 'Submit Reservation';
      
      if (!res.success) {
        showError('Failed to submit reservation: ' + res.message);
        return;
      }
      
      // Success ‚Äî reset form and reload
      document.querySelector('form').reset();
      alert('Reservation submitted! Status: ' + res.data.status);
      loadReservations();
    });
  }
  
  /**
   * Cancels a reservation.
   */
  function cancelReservation(resId) {
    if (!confirm('Cancel this reservation?')) return;
    
    apiCall('cancel', { reservation_id: resId }).then(function(res) {
      if (!res.success) {
        showError('Failed to cancel: ' + res.message);
        return;
      }
      
      alert('Reservation cancelled');
      loadReservations();
    });
  }
  
  /**
   * Setup guest count field visibility.
   */
  document.getElementById('hasGuests').addEventListener('change', function() {
    document.getElementById('guestCountDiv').style.display = this.checked ? 'block' : 'none';
  });
  
  // ============================================================ //
  // SECTION: PROFILE                                             //
  // ============================================================ //
  
  /**
   * Loads and displays the member's profile information.
   */
  /**
   * Helper function to get dial code from country code
   */
  function getDialCode(countryCode) {
    for (var i = 0; i < COUNTRY_DIAL_CODES.length; i++) {
      if (COUNTRY_DIAL_CODES[i].code === countryCode) {
        return COUNTRY_DIAL_CODES[i].dial;
      }
    }
    return countryCode;
  }

  function loadProfile() {
    apiCall('profile', {}).then(function(res) {
      if (!res.success) {
        showError('Failed to load profile: ' + res.message);
        return;
      }

      var member = res.data.member;

      // Format emergency contact phone with dial code lookup
      var emergencyPhone = 'Not provided';
      if (member.phone_emergency && member.country_code_emergency) {
        var dialCode = getDialCode(member.country_code_emergency);
        emergencyPhone = '(+' + dialCode + ') ' + member.phone_emergency;
      } else if (member.phone_emergency) {
        emergencyPhone = member.phone_emergency;
      }

      // Format primary phone with dial code lookup
      var primaryPhone = 'Not provided';
      if (member.phone_primary && member.country_code_primary) {
        var dialCodePrimary = getDialCode(member.country_code_primary);
        primaryPhone = '(+' + dialCodePrimary + ') ' + member.phone_primary;
        if (member.phone_primary_whatsapp) {
          primaryPhone += ' <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height: 16px; width: 16px; margin-left: 6px; vertical-align: middle;">';
        }
      } else if (member.phone_primary) {
        primaryPhone = member.phone_primary;
        if (member.phone_primary_whatsapp) {
          primaryPhone += ' <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height: 16px; width: 16px; margin-left: 6px; vertical-align: middle;">';
        }
      }

      // Format secondary phone with dial code lookup
      var secondaryPhone = 'Not provided';
      if (member.phone_secondary && member.country_code_secondary) {
        var dialCodeSecondary = getDialCode(member.country_code_secondary);
        secondaryPhone = '(+' + dialCodeSecondary + ') ' + member.phone_secondary;
        if (member.phone_secondary_whatsapp) {
          secondaryPhone += ' <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height: 16px; width: 16px; margin-left: 6px; vertical-align: middle;">';
        }
      } else if (member.phone_secondary) {
        secondaryPhone = member.phone_secondary;
        if (member.phone_secondary_whatsapp) {
          secondaryPhone += ' <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height: 16px; width: 16px; margin-left: 6px; vertical-align: middle;">';
        }
      }

      var html = '<div class="detail-row">' +
        '<div class="detail-label">Name</div>' +
        '<div class="detail-value">' + member.first_name + ' ' + member.last_name + '</div>' +
        '</div>' +
        '<div class="detail-row">' +
        '<div class="detail-label">Email</div>' +
        '<div class="detail-value">' + member.email + '</div>' +
        '</div>' +
        '<div class="detail-row">' +
        '<div class="detail-label">Primary Phone</div>' +
        '<div class="detail-value">' + primaryPhone + '</div>' +
        '</div>' +
        '<div class="detail-row">' +
        '<div class="detail-label">Secondary Phone</div>' +
        '<div class="detail-value">' + secondaryPhone + '</div>' +
        '</div>' +
        '<div class="detail-row">' +
        '<div class="detail-label">Emergency Contact Name</div>' +
        '<div class="detail-value">' + (member.emergency_contact_name || 'Not provided') + '</div>' +
        '</div>' +
        '<div class="detail-row">' +
        '<div class="detail-label">Emergency Contact Relationship</div>' +
        '<div class="detail-value">' + (member.emergency_contact_relationship || 'Not provided') + '</div>' +
        '</div>' +
        '<div class="detail-row">' +
        '<div class="detail-label">Emergency Contact Phone</div>' +
        '<div class="detail-value">' + emergencyPhone + '</div>' +
        '</div>';

      document.getElementById('profileContent').innerHTML = html;

      // Initialize phone form and pre-populate with current data
      setTimeout(function() {
        initPhoneForm();

        // Pre-populate primary phone if it exists
        if (member.country_code_primary) {
          document.getElementById('countryPrimary').value = member.country_code_primary;
        }
        if (member.phone_primary) {
          document.getElementById('phonePrimary').value = member.phone_primary;
        }
        if (member.phone_primary_whatsapp) {
          document.getElementById('phonePrimaryWhatsApp').checked = true;
        }

        // Pre-populate secondary phone if it exists
        if (member.country_code_secondary) {
          document.getElementById('countrySecondary').value = member.country_code_secondary;
        }
        if (member.phone_secondary) {
          document.getElementById('phoneSecondary').value = member.phone_secondary;
        }
        if (member.phone_secondary_whatsapp) {
          document.getElementById('phoneSecondaryWhatsApp').checked = true;
        }
      }, 100);
    });
  }
  
  // ============================================================ //
  // SECTION: CARD                                                //
  // ============================================================ //
  
  /**
   * Loads the digital membership card.
   */
  function loadCard() {
    apiCall('card', {}).then(function(res) {
      if (!res.success) {
        showError('Failed to load card: ' + res.message);
        return;
      }
      
      var cards = res.data.cards || [];
      var html = '';
      
      cards.forEach(function(card) {
        html += '<div class="card">' +
          '<div style="background: var(--color-primary); color: white; padding: 16px; border-radius: 6px 6px 0 0; text-align: center;">' +
          '<div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">GEA</div>' +
          '<div style="font-size: 14px; font-weight: 600;">' + card.name + '</div>' +
          '</div>' +
          '<div style="padding: 16px;">' +
          '<div class="detail-row">' +
          '<div class="detail-label">Status:</div>' +
          '<div class="detail-value"><span class="badge badge-' + (card.status === 'ACTIVE' ? 'approved' : 'cancelled') + '">' + card.status + '</span></div>' +
          '</div>' +
          '<div class="detail-row">' +
          '<div class="detail-label">Type:</div>' +
          '<div class="detail-value">' + card.membership_type + '</div>' +
          '</div>' +
          '<div class="detail-row">' +
          '<div class="detail-label">Expires:</div>' +
          '<div class="detail-value">' + card.expiration_date + '</div>' +
          '</div>' +
          '<div class="detail-row">' +
          '<div class="detail-label">Relationship:</div>' +
          '<div class="detail-value">' + card.relationship + '</div>' +
          '</div>' +
          '</div>' +
          '</div>';
      });
      
      document.getElementById('cardContent').innerHTML = html;
    });
  }
  
  // ============================================================ //
  // SECTION: PAYMENTS                                            //
  // ============================================================ //
  
  /**
   * Submits a payment confirmation.
   */
  function submitPayment(event) {
    event.preventDefault();
    
    var method = document.getElementById('paymentMethod').value;
    var reference = document.getElementById('paymentReference').value;
    var date = document.getElementById('paymentDate').value;
    var amountUSD = parseFloat(document.getElementById('amountUSD').value) || 0;
    var amountBWP = parseFloat(document.getElementById('amountBWP').value) || 0;
    var notes = document.getElementById('paymentNotes').value;
    
    var btn = event.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    
    apiCall('payment', {
      payment_method: method,
      payment_reference: reference,
      payment_date: date,
      amount_usd: amountUSD,
      amount_bwp: amountBWP,
      notes: notes
    }).then(function(res) {
      btn.disabled = false;
      btn.textContent = 'Submit Payment';
      
      if (!res.success) {
        showError('Failed to submit payment: ' + res.message);
        return;
      }
      
      // Success ‚Äî reset form
      document.querySelector('form').reset();
      var successBox = document.createElement('div');
      successBox.className = 'success-box';
      successBox.innerHTML = '‚úì Payment submitted successfully! The board will verify and confirm your submission.';
      document.querySelector('#payment .card').insertAdjacentElement('beforebegin', successBox);
    });
  }
  
  // ============================================================ //
  // SECTION: UTILITIES                                           //
  // ============================================================ //
  
  /**
   * Shows an error message to the user.
   */
  function showError(message) {
    alert('Error: ' + message);
    console.error(message);
  }
</script>

</body>
</html>